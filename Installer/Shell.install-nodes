#!/bin/bash

# installer.pylovara – Pylovara Installer Script
# Führe aus: ./installer.pylovara
# Wichtig: Muss mit root-Rechten laufen

echo "🚀 Starte Pylovara Installation..."

# 1. Prüfe Root-Rechte
if [ "$EUID" -ne 0 ]; then 
  echo "❌ Fehler: Dieses Skript benötigt Root-Rechte. Verwende 'sudo' oder melde dich als Root an."
  exit 1
fi

# 2. Setze PV_DIR
export PV_DIR="/Pylovara"

# 3. Erstelle notwendige Ordner (falls noch nicht vorhanden)
mkdir -p /usr/local/bin/
mkdir -p "$PV_DIR/usr/bin/"

# 4. Kopiere den Wrapper nach /usr/local/bin/
cp "$PV_DIR/usr/bin/pylovara.wrapper-shell" /usr/local/bin/ || {
    echo "❌ Fehler beim Kopieren des Wrappers"
    exit 1
}

chmod +x /usr/local/bin/pylovara.wrapper-shell || {
    echo "❌ Fehler beim Setzen der Rechte für den Wrapper"
    exit 1
}

# 5. Trage Wrapper in /etc/shells ein (falls noch nicht vorhanden)
WRAPPER_SHELL="/usr/local/bin/pylovara.wrapper-shell"

if ! grep -Fxq "$WRAPPER_SHELL" /etc/shells; then
    echo "[+] Füge Wrapper zur /etc/shells hinzu"
    echo "$WRAPPER_SHELL" >> /etc/shells
else
    echo "[!] Wrapper bereits in /etc/shells registriert"
fi

# 6. Ändere die Standardshell für den aktuellen Nutzer
CURRENT_USER=$(whoami)
chsh -s /usr/local/bin/pylovara.wrapper-shell "$CURRENT_USER" || {
    echo "❌ Fehler beim Setzen der neuen Shell für $CURRENT_USER"
    exit 1
}

# 7. Optional: Füge source hinzu für Bash/Zsh-Nutzer
if [ -f /bin/bash ]; then
    BASHRC="$HOME/.bashrc"
    if ! grep -q "source \$PV_DIR/Control/control.pv-conf" "$BASHRC"; then
        echo "[+] Füge source zu .bashrc hinzu"
        echo "source \$PV_DIR/Control/control.pv-conf" >> "$BASHRC"
    fi
fi

if [ -f /bin/zsh ]; then
    ZSHRC="$HOME/.zshrc"
    if ! grep -q "source \$PV_DIR/Control/control.pv-conf" "$ZSHRC"; then
        echo "[+] Füge source zu .zshrc hinzu"
        echo "source \$PV_DIR/Control/control.pv-conf" >> "$ZSHRC"
    fi
fi

# 8. Fertig! Hinweis für Nutzer
echo ""
echo "✅ Installation abgeschlossen!"
echo ""
echo "🔄 Terminal neu starten:"
echo "exec /usr/local/bin/pylovara.wrapper-shell"
echo ""
echo "💡 ODER einfach neu anmelden – danach steht alles bereit."
echo ""
echo "🔍 Funktionen wie p, dna, helpme, ki sind ab jetzt global verfügbar."

exit 0
